<html>
    <head>
        <title>SecretStick - 高效安全的加密工具</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="node_modules/mdui/mdui.css">
        <link href="node_modules/material-icons/iconfont/material-icons.css" rel="stylesheet">
        <script type="text/javascript" src="node_modules/mdui/mdui.global.js"></script>
        <script type="text/javascript" src="node_modules/downloadjs/download.js"></script>
        <script>
            var slot = -1, serialPath = "", dataFile = null;
            function login_out_toggle(){
                if(slot == -1) loginOnclick();
                elselogout();
            }
            function chooseSerial(){
                serialPath = document.getElementById("device").value;
            }
            async function login(){
                if(slot < 0 || slot > 101){
                    mdui.dialog({headline: "操作失败！密码区应在 0 - 101 之间。", actions:[{text: '确定'}]});
                    return;
                }
                var ret = await window.electronAPI.login(serialPath, parseInt(document.getElementById('login_slot').value), document.getElementById('password').value);
                if(ret == 1){
                    slot = parseInt(document.getElementById('login_slot').value);
                    document.getElementById("login_out-icon").icon = "logout";
                    document.getElementById("app-title").innerText = "SecretStick - 当前正在使用 " + slot + " 号密码区";
                    mdui.dialog({headline: "操作成功！"});
                    return;
                }
                mdui.dialog({headline: "操作失败！"});
            }
            function logout(){
                slot = -1;
                window.electronAPI.logout(serialPath);
                document.getElementById("login_out-icon").icon = "login";
                document.getElementById("app-title").innerText = "SecretStick - 当前未登录";
                mdui.dialog({headline: "操作成功！"});
            }
            function generateOnclick(){
                document.getElementById("login-dialog").setAttribute('headline', '请选择要生成密钥对的密码区');
                document.getElementById("login-button").innerText = "生成并覆盖原密钥";
                document.getElementById("login-button").onclick = "document.getElementById('login-dialog').setAttribute('open', false); generate();";
                document.getElementById('login-dialog').setAttribute('open', true);
            }
            function loginOnclick(){
                document.getElementById("login-dialog").setAttribute('headline', '请输入登录凭证');
                document.getElementById("login-button").innerText = "登录";
                document.getElementById("login-button").onclick = "document.getElementById('login-dialog').setAttribute('open', false); login();";
                document.getElementById('login-dialog').setAttribute('open', true);
            }
            async function generate(){
                if(slot < 0 || slot > 101){
                    mdui.dialog({headline: "操作失败！密码区应在 0 - 101 之间。", actions:[{text: '确定'}]});
                    return;
                }
                var ret = await window.electronAPI.generate(serialPath, parseInt(document.getElementById('login_slot').value), document.getElementById('password').value);
                if(ret == 1){
                    slot = parseInt(document.getElementById('login_slot').value);
                    document.getElementById("login_out-icon").icon = "logout";
                    document.getElementById('getKeyButton').style = "";
                    document.getElementById("app-title").innerText = "SecretStick - 当前正在使用 " + slot + " 号密码区";
                    mdui.dialog({headline: "操作成功！", actions:[{text: '确定'}]});
                    return;
                }
                mdui.dialog({headline: "操作失败！", actions:[{text: '确定'}]});
            }
            async function sign(){
                if(slot == -1){
                    mdui.dialog({headline: "操作失败：未登录！", actions:[{text: '确定'}]});
                    return;
                }
                var data = (dataFile == null) ? document.getElementById('data-text').value : dataFile;
                var hash = await window.crypto.subtle.digest('SHA-256', data);
                var ret = await window.electronAPI.sign(serialPath, data);
                mdui.dialog({headline: "操作成功，现提供数字签名", body: "<mdui-text-field readonly>" + JSON.stringify({hash: btoa(hash), sign: btoa(data)}) + "</mdui-text-field>", actions:[{text: '确定'}]});
            }
            async function verify(){
                var data = (dataFile == null) ? document.getElementById('data-text-verify').value : dataFile;
                var hash = await window.crypto.subtle.digest('SHA-256', data);
                var signed = JSON.parse(document.getElementById('sign-text-verify').value);
                var pub = atob(document.getElementById("publicKey").value);
                if(!signed || btoa(await window.crypto.subtle.digest('SHA-256', data)) != signed.hash || !(await window.electronAPI.verify(signed, pub))){
                    mdui.dialog({headline: "验证失败：错误的数字签名！", actions:[{text: '确定'}]});
                    return;
                }
                mdui.dialog({headline: "验证成功！", actions:[{text: '确定'}]});
            }
            async function encrypt(){
                if(slot == -1){
                    mdui.dialog({headline: "操作失败：未登录！", actions:[{text: '确定'}]});
                    return;
                }
                var data = (dataFile == null) ? document.getElementById('data-text').value : dataFile;
                var result = new Array;
                for(var i = 0; i < ceil((data.length) / 512.0); i++){
                    var subdata = data.substring(i * 512, min((i + 1) * 512, data.length));
                    result.push(await window.electronAPI.encrypt(serialPath, data));
                }
                download(JSON.stringify(result), 'encrypted.json', 'text/plain');
            }
            async function encryptShared(){
                if(slot == -1){
                    mdui.dialog({headline: "操作失败：未登录！", actions:[{text: '确定'}]});
                    return;
                }
                var data = (dataFile == null) ? document.getElementById('data-text').value : dataFile;
                var pub = atob(document.getElementById("publicKey").value);
                var result = new Array;
                for(var i = 0; i < ceil((data.length) / 512.0); i++){
                    var subdata = data.substring(i * 512, min((i + 1) * 512, data.length));
                    result.push(await window.electronAPI.encryptShared(serialPath, pub, data));
                }
                download(JSON.stringify(result), 'encrypted.json', 'text/plain');
            }
            async function decrypt(){
                if(slot == -1){
                    mdui.dialog({headline: "操作失败：未登录！", actions:[{text: '确定'}]});
                    return;
                }
                var data = JSON.parse((dataFile == null) ? document.getElementById('data-text').value : dataFile);
                var fileContent = "";
                for(var i = 0; i < data.length; i++){
                    fileContent += window.electronAPI.decrypt(serialPath, data.data, data.iv);
                }
                download(fileContent, 'decrypted.json', 'application/octet-stream');
            }
            async function decryptShared(){
                if(slot == -1){
                    mdui.dialog({headline: "操作失败：未登录！", actions:[{text: '确定'}]});
                    return;
                }
                var data = JSON.parse((dataFile == null) ? document.getElementById('data-text').value : dataFile);
                var pub = atob(document.getElementById("publicKey").value);
                var fileContent = "";
                for(var i = 0; i < data.length; i++){
                    fileContent += window.electronAPI.decrypt(serialPath, pub, data.data, data.iv);
                }
                download(fileContent, 'decrypted.json', 'application/octet-stream');
            }
            async function getPublicKey(){
                if(slot == -1){
                    mdui.dialog({headline: "操作失败：未登录！", actions:[{text: '确定'}]});
                    return;
                }
                download(window.electronAPI.getPublicKey(serialPath), 'public.key', 'application/octet-stream');
            }
            function switchTab(num){
                if(num == 0){
                    document.getElementById('default-div').style = "";
                    document.getElementById('feature-div').style = "display: none;";
                    document.getElementById('verify-div').style = "display: none;";
                }else if(num == 1){
                    document.getElementById('verify-div').style = "";
                    document.getElementById('default-div').style = "display: none;";
                    document.getElementById('feature-div').style = "display: none;";
                }else{
                    document.getElementById('feature-div').style = "";
                    document.getElementById('default-div').style = "display: none;";
                    document.getElementById('verify-div').style = "display: none;";
                    if(num == 2){
                        document.getElementById("encrypt").innerText = "使用密钥加密";
                        document.getElementById("encrypt").onclick = "encrypt();";
                        document.getElementById("encrypt").innerText = "使用密钥解密";
                        document.getElementById("encrypt").onclick = "decrypt();";
                    }else{
                        document.getElementById("encrypt").innerText = "使用共享密钥加密";
                        document.getElementById("encrypt").onclick = `
                            document.getElementById('public-confim').onclick = "document.getElementById('public-dialog').setAttribute('open', false); encryptShared();";
                            document.getElementById('public-dialog').setAttribute('open', true);
                        `;
                        document.getElementById("encrypt").innerText = "使用共享密钥解密";
                        document.getElementById("encrypt").onclick = `
                            document.getElementById('public-confim').onclick = "document.getElementById('public-dialog').setAttribute('open', true); decryptShared();";
                            document.getElementById('public-dialog').setAttribute('open', true);
                        `;
                    }
                }
            }
            window.onload = () => {
                (async () => {
                    var list = await window.electronAPI.list();
                    var devices = 0;
                    for(var i = 0; i < list.length; i++){
                        if(window.electronAPI.check(list[i].path)){
                            var item = document.createElement('mdui-list-item');
                            item.innerHTML = list[i].path + `
                                <mdui-radio value="` + list[i].path + `" slot="end-icon" ></mdui-radio>
                            `;
                            if(devices == 0) document.getElementById("device").value = list[i].path;
                            document.getElementById("serial-list").appendChild(item);
                            devices++;
                        }
                    }
                    if(list.length == 0){
                        document.getElementById("serial-list-div").innerText = "未找到串口设备，请检查设备连接。";
                        document.getElementById("serial-list-confim").disabled = 1;
                    }
                    document.getElementById("serial-list-dialog").setAttribute('open', true);
                })();
            };
        </script>
    </head>
    <body>
        <mdui-top-app-bar>
            <mdui-button-icon icon="menu" onclick="document.getElementById('navi-drawer').setAttribute('open', !JSON.parse(document.getElementById('navi-drawer').getAttribute('open')));"></mdui-button-icon>
            <mdui-top-app-bar-title id="app-title">
                SecretStick - 当前未登录
            </mdui-top-app-bar-title>
            <div style="flex-grow: 1"></div>
            <mdui-button-icon id="login_out-icon" onclick="login_out_toggle();" icon="login"></mdui-button-icon>
            <mdui-button-icon onclick="generateOnclick();" icon='app_registration'></mdui-button-icon>
            <mdui-button-icon onclick="getPublicKey();" icon='vpn_key' id="getKeyButton"></mdui-button-icon>
        </mdui-top-app-bar>
        <mdui-navigation-drawer id="navi-drawer" open="true">
            <mdui-list>
                <mdui-list-item></mdui-list-item>
                <mdui-list-item onclick="switchTab(2);">
                    <mdui-icon name='enhanced_encryption'></mdui-icon>
                    使用密钥对加/解密内容
                </mdui-list-item>
                <mdui-list-item onclick="switchTab(3);">
                    <mdui-icon name="share"></mdui-icon>
                    使用共享密钥加/解密内容
                </mdui-list-item>
                <mdui-list-item onclick="switchTab(1);">
                    <mdui-icon name='assignment'></mdui-icon>
                    验证数字签名
                </mdui-list-item>
                <mdui-list-item onclick="switchTab(0);">
                    <mdui-icon name="info"></mdui-icon>
                    关于
                </mdui-list-item>
            </mdui-list>
        </mdui-navigation-drawer>
        <mdui-dialog id="login-dialog" headline="请输入登录凭证">
            <mdui-text-field id="login_slot" label="密码区域编号"></mdui-text-field>
            <mdui-text-field id="password" label="密码"></mdui-text-field>
            <mdui-button slot="action" variant="text" onclick="document.getElementById('login-dialog').setAttribute('open', false);">取消</mdui-button>
            <mdui-button slot="action" variant="tonal" id="login-button" onclick="document.getElementById('login-dialog').setAttribute('open', false); login();">登录</mdui-button>
        </mdui-dialog>
        <mdui-dialog id="serial-list-dialog" headline="请选择使用的设备">
            <mdui-radio-group id="device">
                <div id="serial-list-div"><mdui-list id="serial-list"></mdui-list></div>
            </mdui-radio-group>
            <mdui-button slot="action" variant="text" onclick="window.electronAPI.exit();">取消</mdui-button>
            <mdui-button slot="action" variant="tonal" id="serial-list-confim" onclick="document.getElementById('serial-list-dialog').setAttribute('open', false); chooseSerial();">选择</mdui-button>
        </mdui-dialog>
        <mdui-dialog id="public-dialog" headline="请选择使用的公钥">
            <mdui-text-field rows="4" id="publicKey" label="公钥文本"></mdui-text-field>
            <mdui-button slot="action" variant="text" onclick="document.getElementById('public-dialog').setAttribute('open', false);">取消</mdui-button>
            <mdui-button variant="elevated" onclick="(async () => {
                document.getElementById('publicKey').value = await window.electronAPI.openFile();
            })()">从文件加载</mdui-button> 
            <mdui-button slot="action" variant="tonal" id="public-confim">选择</mdui-button>
        </mdui-dialog>
        <mdui-layout-main>
            <div id="default-div">
                <h1>SecretStick</h1>
                <p>一根可以完全保护隐私的魔法棒！</p>
                <h3>特性</h3>
                <ul><li>集成 secp256k1 椭圆曲线加密，用来生成可供加密的密钥对</li><li>使用 FRAM 铁电存储器，常温下可保存数据 200 年，并支持无限次读写和极低的功耗</li><li>离线数据保护，使用 AES-256 算法和密码保护你的密钥不被离线读取</li><li>支持多种加密方式，包括密钥交换算法加密以及直接加密，这些都基于 AES-256 算法</li><li>内置 256 位的 SHA-3 算法</li></ul>
                <h3>贡献</h3>
                <p>本项目基于 GPL-3.0，即使致力于保护数据，但不对数据丢失、泄漏提供任何担保。</p>
                <p>请贡献这个仓库，让我们的设备做得更好！</p>
            </div>
            <div id="feature-div" style="display: none;">
                <mdui-text-field rows="8" label="请输入待处理的数据" id="data-text"></mdui-text-field>
                <mdui-button variant="elevated" onclick="(async () => {
                    dataFile = await window.electronAPI.openFile();
                    document.getElementById('data-text').value = '（从文件加载）';
                    document.getElementById('data-text').setAttribute('readonly', 'true');
                })()">从文件加载</mdui-button> 
                <mdui-button variant="elevated" onclick="dataFile = null; document.getElementById('data-text').value = ''; 
                    document.getElementById('data-text').removeAttribute('readonly');">清除加载的文件</mdui-button> 
                <mdui-button variant="elevated" id="encrypt">加密</mdui-button> 
                <mdui-button variant="elevated" id="decrypt">解密</mdui-button>
                <mdui-button variant="elevated" id="sign" onclick="sign();">签名</mdui-button>
            </div>
            <div id="verify-div" style="display: none;">
                <mdui-text-field rows="8" label="请输入待处理的数据" id="data-text-verify"></mdui-text-field>
                <mdui-text-field rows="8" label="请输入待处理的数字签名" id="sign-text-verify"></mdui-text-field>
                <mdui-button variant="elevated" onclick="(async () => {
                    dataFile = await window.electronAPI.openFile();
                    document.getElementById('data-text').value = '（从文件加载）';
                    document.getElementById('data-text').setAttribute('readonly', 'true');
                })()">从文件加载</mdui-button> 
                <mdui-button variant="elevated" onclick="dataFile = null; document.getElementById('data-text').value = ''; 
                    document.getElementById('data-text').removeAttribute('readonly');">清除加载的文件</mdui-button> 
                <mdui-button variant="elevated" id="verify" onclick="
                    document.getElementById('public-confim').onclick = `document.getElementById('public-dialog').setAttribute('open', false); verify();`;
                        document.getElementById('public-dialog').setAttribute('open', true);
                ">验证</mdui-button> 
            </div>
        </mdui-layout-main>
    </body>
</html>